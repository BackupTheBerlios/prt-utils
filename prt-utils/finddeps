#!/bin/bash
# Find dependency of files in /usr/lib and /usr/bin of a port by looking at
#  the output of ldd
#
# Johannes Winkelmann <jw@tks6.net>

version=1.4

export LD_LIBRARY_PATH=/usr/lib:/usr/X11/lib:$LD_LIBRARY_PATH

function printDep() {
    deps=()
    for f in `awk '/usr\/(bin|lib)/ {print $3}' $1/.footprint`; do
	if [ -f "/$f" ]; then
	    deps=(${deps[*]} `ldd /$f 2> /dev/null | awk '!/(linux-gate)|( dynamic)/ {print $3}'`)
	fi
    done

    deps=(`for t in  ${deps[*]}; do echo $t; done|sort|uniq`)

  for d in ${deps[*]}; do
    in=`echo $d|sed -e 's|^/||'`
    awk -v search=$in 'BEGIN {RS=""}; $0 ~ search {print $1}' /var/lib/pkg/db
  done
}


if [ "$1" = "" ]; then
    echo "Usage: `basename $0` <port directory>"
    exit -1
fi

if [ ! -f "$1/.footprint" ]; then
    echo "$1 doesn't seem to be a port directory: footprint is missing"
    echo "Usage: `basename $0` <port directory>"
    exit -2
fi

prt-get isinst `basename $1` &> /dev/null
if [ $? -ne 0 ]; then
    echo "$1 is not installed"
    exit -3
fi

pkgName=`basename $1`
depPkg=`printDep $1|sort|uniq|grep -v $pkgName`

for p in $depPkg; do
    echo -n $p
    coll=`prt-get printf "%p" --filter=$p|sed -e 's|.*/||'`
    if [ "$coll" != "" ]; then
	echo -n " ($coll)"
    fi
    echo ""
done|sort -k 2
